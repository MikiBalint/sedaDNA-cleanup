# General details
  #All done on the malloy
  #Data in: /phylodata/mbalint/workdir/Stechlin_preexp/data
  #Workdir: /phylodata/mbalint/workdir/Stechlin_preexp

# 1: Quality check:
  #folder: 01_fastqc
  #parallel citation: Tange 2011

    ls ../data/*001.fastq | parallel -j 40 'fastqc'

    mv ../data/*.html .

    rm ../data/*.zip

# 2: Trimming
  #Check the trimming length with the primers.
  #Primers (from Taberlet): i18S_V9_F, i18S_V9_R
  #Fragment length: most species ~110 bp, some ~150 bp + primers 2 x 20 bp
  #All reads trimmed to 100 bp: this should be shorter then the fragment length, and allows the assembly of the ~150 bp reads (fragment + primer)

    cd ../
    mkdir 02_trimmed
    cd 02_trimmed
    ln -s ../data/*.fastq . # link because the parallel is simpler for me
    ls *001.fastq | parallel -j 60 'fastx_trimmer -t 51 -i {} -o {.}_trimmed.fastq' # -t: remove 51 nucleotides from the ends
    rm *001.fastq # remove the links. the -j 60 option of the parallel uses 60 processors

# 3: Paired-end assembly:

    cd ../
    mkdir 03_paired-end
    cd 03_paired-end

  #link all files into present folder, because it is less complicated to use the parallel inputting for me

    ln -s ../02_trimmed/*.fastq .

    ls *.fastq | grep -v R2_001_trimmed.fastq | sed 's/R1_001_trimmed.fastq//' | parallel -j 60 'illuminapairedend --score-min=40  -r {.}R2_001_trimmed.fastq {.}R1_001_trimmed.fastq > {.}paired.fastq'

  #1. list the filenames.
  #2. keep the file name stems by removing the forward-reverse specific file information with 'sed'.
  #3. give the filename stems to parallel as '{.}'.

  #remove the links

    rm *001.fastq

  #Paired quality check

    mkdir fastqc_paired # create a folder for the fastqc output
    ls *_paired.fastq | parallel -j 60 'fastqc -o fastqc_paired {}'
    rm fastqc_paired/*.zip # keep only the htmls



Remove unaligned :
04_aligned
combine reads
cat ../03_paired_end/paired_BA_S*.fastq > combined_BA.fastq
obigrep -p 'mode!="joined"' combined_BA.fastq > combined_ali.fastq
grep -c "@NS500764" *.fastq
combined_ali.fastq : 12540598

Demultiplex :
05_demux
ngsfilter -t bol_frogs_ngsfilter.txt -u unidentified_samples.fastq combined_ali.fastq > grep -c "@NS500764" frogs_demuxed.fastq
10298057
16S reads:
grep -c "experiment=16S" frogs_demuxed.fastq
9479299

Dereplicate into unique sequences :
06_erep
obiuniq -m sample frogs_demuxed.fastq > frogs_derep.fasta
grep -c "^>" frogs_derep.fasta
631003

Denoise the dataset :
07_denoise
Get the counts of the 20 rarest sequences: 511117 sequences occur only once
obistat -c count ../7_derep/bol_frogs_7_derep.fasta | sort -nk1 | head -20
count     count     total
1        511117    511117
2         49412     98824
3         18888     56664
4         10130     40520
5          6479     32395
6          4515     27090
7          3305     23135
8          2472     19776
9          1979     17811
10         1646     16460
11         1319     14509
12         1163     13956
13         1063     13819
14          946     13244
15          859     12885
16          673     10768
17          643     10931
18          585     10530
19          502      9538

Keep only the sequence variants having a count greater or equal to 10:
obigrep -p 'count>=10' frogs_derep.fasta > frogs_c10.fasta
grep -c "^>" frogs_c10.fasta
22706

Clean the sequences :
08_clean

keep only head sequences ( -H option) if these are sequences with no variants with a count greater than 5% of their own count ( -r 0.05 option). This also annotates sequences as head, internal or singleton in a sample.
obiclean -s merged_sample -r 0.05 -H ../8_denoise/bol_frogs_8_denoise_c10.fasta > bol_frogs_9_clean.fasta
grep -c "^>" frogs_clean.fasta
14442

ecoPCR databases :
own 16S reference sequences + the ones from the GenBank:
09_ecopcr/own/16S

See the commands below for generating the ecopcr databases

Assign so far not assigned sequences to EMBL :
10_assign
Own references
ecotag -d 16S_bolivian_frogs.db -R 16S_fasta_nonredundant_noprimers.fasta --sort=count -m 0.98 -r frogs_clean.fasta > frogs_own16S_assigned.fasta

# grep assigned
obigrep -v -a 'scientific_name:root' frogs_own16S_sort.fasta > frogs_16S_own_assigned.fasta

# grep not assigned
obigrep -a 'scientific_name:root' frogs_own16S_sort.fasta > frogs_16S_not_assigned.fasta

# counts

frogs_16S_assigned.fasta:4805
frogs_16S_not_assigned.fasta:9637

# assignment against the GenBank database
ecotag -d /phylodata/mbalint/databases/ecoPCR_embl_125/ecoPCR_embl_125 -R ../09_ecopcr/NCBI/16S/db_16S.fasta --sort=count -m 0.98 -r frogs_16S_not_assigned.fasta > frogs_16S_EMBL_assigned.fasta

# counts
grep -c "scientific_name=" *.fasta
16S_fasta_nonredundant_noprimers.fasta:86
frogs_16S_EMBL_assigned.fasta:9637
frogs_16S_not_assigned.fasta:9637
frogs_16S_own_assigned.fasta:4805
frogs_clean.fasta:0
frogs_own16S_annot.fasta:14442
frogs_own16S_assigned.fasta:14442
frogs_own16S_sort.fasta:14442

grep -c "scientific_name=root" *.fasta
16S_fasta_nonredundant_noprimers.fasta:0
frogs_16S_EMBL_assigned.fasta:7807
frogs_16S_not_assigned.fasta:9637
frogs_16S_own_assigned.fasta:0
frogs_clean.fasta:0
frogs_own16S_annot.fasta:9637
frogs_own16S_assigned.fasta:9637
frogs_own16S_sort.fasta:9637

11_abundance_tables
# Remove non-informative annotations
obiannotate  --delete-tag=scientific_name_by_db --delete-tag=obiclean_samplecount --delete-tag=obiclean_count --delete-tag=obiclean_singletoncount --delete-tag=obiclean_cluster --delete-tag=obiclean_internalcount --delete-tag=obiclean_head --delete-tag=taxid_by_db --delete-tag=obiclean_headcount --delete-tag=id_status --delete-tag=rank_by_db --delete-tag=order_name --delete-tag=order --delete_tag=sminR --delete_tag=sminL --delete_tag= frogs_16S_own_assigned.fasta > frogs_16S_own_annot.fasta

obiannotate  --delete-tag=scientific_name_by_db --delete-tag=obiclean_samplecount --delete-tag=obiclean_count --delete-tag=obiclean_singletoncount --delete-tag=obiclean_cluster --delete-tag=obiclean_internalcount --delete-tag=obiclean_head --delete-tag=taxid_by_db --delete-tag=obiclean_headcount --delete-tag=id_status --delete-tag=rank_by_db --delete-tag=order_name --delete-tag=order frogs_16S_EMBL_assigned.fasta > frogs_16S_EMBL_annot.fasta

# Sort them
obisort -k count -r frogs_16S_own_annot.fasta > frogs_16S_own_sort.fasta

obisort -k count -r frogs_16S_EMBL_annot.fasta > frogs_16S_EMBL_sort.fasta

# create 16S assigned abundance matrix
obitab -o --output-field-separator=, frogs_16S_own_sort.fasta > frogs_16S_own.tab

obitab -o --output-field-separator=, frogs_16S_EMBL_sort.fasta > frogs_16S_EMBL.tab
